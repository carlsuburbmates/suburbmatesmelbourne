{
  "metadata": {
    "project": "Suburbmates",
    "phase": "Phase 1 - tRPC Endpoint Analysis",
    "generatedOn": "2025-11-03",
    "sourceFile": "server/routers.ts",
    "analysisMethod": "Manual filesystem MCP inspection",
    "framework": "tRPC v11",
    "totalEndpoints": 19
  },
  "routers": {
    "system": {
      "type": "systemRouter",
      "source": "_core/systemRouter.ts",
      "description": "Manus platform system endpoints",
      "procedures": [],
      "note": "Imported from Manus framework"
    },
    "auth": {
      "procedures": {
        "me": {
          "type": "query",
          "access": "public",
          "input": "none",
          "output": "User | null",
          "description": "Get current authenticated user"
        },
        "logout": {
          "type": "mutation",
          "access": "public",
          "input": "none",
          "output": "{ success: true }",
          "description": "Clear session cookie and logout user"
        }
      },
      "totalProcedures": 2
    },
    "business": {
      "procedures": {
        "list": {
          "type": "query",
          "access": "public",
          "input": {
            "suburb": "string (optional)",
            "businessName": "string (optional)",
            "limit": "number (1-100, default: 20)",
            "offset": "number (min: 0, default: 0)"
          },
          "output": "Business[]",
          "description": "List all active businesses with optional filtering"
        },
        "getById": {
          "type": "query",
          "access": "public",
          "input": { "id": "number" },
          "output": "Business",
          "description": "Get a specific business by ID"
        },
        "myBusinesses": {
          "type": "query",
          "access": "protected",
          "input": "none",
          "output": "Business[]",
          "description": "Get all businesses owned by current user",
          "requiresAuth": true
        },
        "create": {
          "type": "mutation",
          "access": "protected",
          "input": {
            "businessName": "string (1-255 chars)",
            "abn": "string (11 chars, optional)",
            "services": "string (optional)",
            "about": "string (optional)",
            "address": "string (optional)",
            "suburb": "string (optional)",
            "phone": "string (optional)",
            "website": "url (optional)",
            "openingHours": "string (optional)",
            "profileImage": "string (optional)"
          },
          "output": "{ success: true, businessId: number }",
          "description": "Create a new business",
          "requiresAuth": true,
          "requiresRole": ["business_owner", "vendor", "admin"],
          "sideEffects": ["trackBusinessCreated (PostHog analytics)"]
        },
        "submitABN": {
          "type": "mutation",
          "access": "protected",
          "input": {
            "businessId": "number",
            "abn": "string (11 chars)"
          },
          "output": "{ success: true, abnDetails: ABNDetails, message: string }",
          "description": "Submit ABN for verification via Australian Business Register",
          "requiresAuth": true,
          "requiresOwnership": "business",
          "externalApi": "Australian Business Register (ABR)",
          "validation": [
            "ABN must exist in ABR",
            "ABN must be active",
            "User must own business or be admin"
          ]
        },
        "getMelbournSuburbs": {
          "type": "query",
          "access": "public",
          "input": { "limit": "number (optional)" },
          "output": "MelbournSuburb[]",
          "description": "Get Melbourne suburbs for geofencing"
        }
      },
      "totalProcedures": 6
    },
    "agreement": {
      "procedures": {
        "accept": {
          "type": "mutation",
          "access": "protected",
          "input": {
            "businessId": "number",
            "agreementType": "enum [terms_of_service, privacy_policy, vendor_agreement]",
            "version": "string"
          },
          "output": "{ success: true, agreementId: number }",
          "description": "Accept an agreement for a business",
          "requiresAuth": true,
          "requiresOwnership": "business",
          "tracking": ["ipAddress", "userAgent"]
        },
        "getByBusinessId": {
          "type": "query",
          "access": "public",
          "input": { "businessId": "number" },
          "output": "Agreement[]",
          "description": "Get all agreements for a business"
        },
        "getLatest": {
          "type": "query",
          "access": "public",
          "input": {
            "businessId": "number",
            "agreementType": "enum [terms_of_service, privacy_policy, vendor_agreement]"
          },
          "output": "Agreement | null",
          "description": "Get the latest version of a specific agreement type"
        }
      },
      "totalProcedures": 3
    },
    "consent": {
      "procedures": {
        "set": {
          "type": "mutation",
          "access": "protected",
          "input": {
            "consentType": "enum [marketing_emails, sms_notifications, analytics, third_party_sharing]",
            "granted": "boolean",
            "version": "string",
            "expiresAt": "date (optional)"
          },
          "output": "{ success: true, consentId: number }",
          "description": "Log a consent action (legacy format, maps to new system)",
          "requiresAuth": true,
          "deprecated": "Use consent.log instead for audit-ready consent tracking",
          "implementation": "Maps to action-based system"
        },
        "getAll": {
          "type": "query",
          "access": "protected",
          "input": "none",
          "output": "Consent[]",
          "description": "Get all consents for current user",
          "requiresAuth": true
        },
        "get": {
          "type": "query",
          "access": "protected",
          "input": {
            "consentType": "enum [marketing_emails, sms_notifications, analytics, third_party_sharing]"
          },
          "output": "Consent[]",
          "description": "Get actions for current user containing a specific consent type",
          "requiresAuth": true,
          "note": "Filters actions by consentType substring match"
        },
        "log": {
          "type": "mutation",
          "access": "protected",
          "input": { "action": "string (1-255 chars)" },
          "output": "{ success: true, consentId: number, immutableHash: string }",
          "description": "Log an immutable consent action with cryptographic hash",
          "requiresAuth": true,
          "complianceFeature": "Creates audit-ready record for GDPR compliance",
          "security": "SHA-256 immutable hash"
        }
      },
      "totalProcedures": 4
    },
    "emailVerification": {
      "procedures": {
        "requestToken": {
          "type": "mutation",
          "access": "public",
          "input": { "email": "email string" },
          "output": "{ success: true, message: string, expiresAt: Date }",
          "description": "Request an email verification token (passwordless login)",
          "tokenExpiry": "24 hours",
          "security": "32-byte random hex token"
        },
        "verifyToken": {
          "type": "mutation",
          "access": "public",
          "input": { "token": "string" },
          "output": "{ success: true, user: User }",
          "description": "Verify an email token and create/update user",
          "autoRegistration": "Creates new user with 'buyer' role if not exists",
          "tokenUsage": "Single-use, marked as used after verification"
        }
      },
      "totalProcedures": 2
    },
    "llm": {
      "procedures": {
        "generateBusinessDescription": {
          "type": "mutation",
          "access": "protected",
          "input": {
            "name": "string (1-255 chars)",
            "category": "string (optional)"
          },
          "output": "{ success: true, description: string }",
          "description": "Generate business description using AI",
          "requiresAuth": true,
          "externalService": "OpenAI API",
          "dynamicImport": true,
          "note": "AI-powered profile builder"
        }
      },
      "totalProcedures": 1
    }
  },
  "summary": {
    "totalRouters": 7,
    "totalProcedures": 19,
    "publicEndpoints": 8,
    "protectedEndpoints": 11,
    "queries": 9,
    "mutations": 10,
    "externalIntegrations": [
      "Australian Business Register (ABR)",
      "OpenAI API (LLM)",
      "PostHog Analytics"
    ]
  },
  "authentication": {
    "publicProcedure": "No authentication required",
    "protectedProcedure": "Requires authenticated user via Manus OAuth",
    "roleChecks": ["business_owner", "vendor", "admin"],
    "ownershipChecks": ["business ownership verification"]
  },
  "securityFeatures": {
    "csrf": "Cookie-based session with secure options",
    "encryption": "SHA-256 immutable hashes for consent logs",
    "ipTracking": "IP address captured in agreements",
    "tokenExpiry": "24-hour email verification tokens",
    "singleUse": "Email tokens marked as used after verification"
  },
  "complianceFeatures": {
    "gdpr": {
      "consentManagement": "consent.log with immutable hashes",
      "dataAccess": "consent.getAll for user data retrieval",
      "auditTrail": "IP and user agent tracking in agreements"
    },
    "australian": {
      "abnVerification": "business.submitABN",
      "businessRegister": "Integration with ABR SOAP API"
    }
  },
  "deprecations": {
    "consent.set": "Use consent.log instead for audit-ready tracking"
  }
}
