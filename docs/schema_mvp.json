{
  "metadata": {
    "source": "suburbmates2/drizzle/schema.ts",
    "phase": "MVP (Pre-Copilot Build)",
    "exportedAt": "2025-11-03",
    "description": "Complete MVP schema defining marketplace tables and business directory"
  },
  "tables": {
    "users": {
      "columns": 9,
      "primaryKey": "id",
      "description": "Core user table backing auth flow",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "openId": { "type": "varchar(64)", "constraints": ["notNull", "unique"], "required": true, "notes": "Manus OAuth identifier" },
        "name": { "type": "text", "constraints": [], "required": false },
        "email": { "type": "varchar(320)", "constraints": [], "required": false },
        "loginMethod": { "type": "varchar(64)", "constraints": [], "required": false },
        "role": { "type": "enum", "values": ["user", "admin"], "default": "user", "required": true },
        "createdAt": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true },
        "updatedAt": { "type": "timestamp", "constraints": ["defaultNow", "onUpdateNow", "notNull"], "required": true },
        "lastSignedIn": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true }
      }
    },
    "businesses": {
      "columns": 15,
      "primaryKey": "id",
      "foreignKeys": ["ownerId → users.id (onDelete: cascade)"],
      "description": "Business Directory - stores all registered businesses (Business Owners and Vendors)",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "ownerId": { "type": "int", "constraints": ["notNull", "references:users.id"], "required": true },
        "businessName": { "type": "varchar(255)", "constraints": ["notNull"], "required": true },
        "abn": { "type": "varchar(11)", "constraints": [], "required": false, "notes": "Australian Business Number" },
        "abnVerifiedStatus": { "type": "enum", "values": ["verified", "pending", "failed"], "default": "pending", "required": true },
        "services": { "type": "text", "constraints": [], "required": false, "notes": "JSON array of services offered" },
        "about": { "type": "text", "constraints": [], "required": false, "notes": "Rich text description" },
        "address": { "type": "varchar(255)", "constraints": [], "required": false },
        "suburb": { "type": "varchar(100)", "constraints": [], "required": false, "notes": "Melbourne suburb for hyper-local filtering" },
        "postcode": { "type": "varchar(4)", "constraints": [], "required": false, "notes": "Australian postcode" },
        "phone": { "type": "varchar(20)", "constraints": [], "required": false },
        "website": { "type": "varchar(255)", "constraints": [], "required": false },
        "openingHours": { "type": "text", "constraints": [], "required": false, "notes": "JSON object with day/time info" },
        "profileImageUrl": { "type": "varchar(255)", "constraints": [], "required": false, "notes": "S3 URL" },
        "coverImageUrl": { "type": "varchar(255)", "constraints": [], "required": false, "notes": "S3 URL" },
        "createdAt": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true },
        "updatedAt": { "type": "timestamp", "constraints": ["defaultNow", "onUpdateNow", "notNull"], "required": true }
      }
    },
    "vendors_meta": {
      "columns": 7,
      "primaryKey": "id",
      "foreignKeys": ["businessId → businesses.id (unique, onDelete: cascade)"],
      "description": "Vendor Metadata - created when Business Owner upgrades to Vendor (completes Stripe onboarding)",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "businessId": { "type": "int", "constraints": ["notNull", "unique", "references:businesses.id"], "required": true },
        "stripeAccountId": { "type": "varchar(255)", "constraints": ["notNull", "unique"], "required": true },
        "fulfilmentTerms": { "type": "text", "constraints": [], "required": false, "notes": "JSON object with pickup/delivery options" },
        "refundPolicyUrl": { "type": "varchar(255)", "constraints": [], "required": false },
        "createdAt": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true },
        "updatedAt": { "type": "timestamp", "constraints": ["defaultNow", "onUpdateNow", "notNull"], "required": true }
      }
    },
    "agreements": {
      "columns": 7,
      "primaryKey": "id",
      "description": "Legal Agreements - stores all platform agreements (buyer_tos, vendor_tos, etc.)",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "type": { "type": "enum", "values": ["buyer_tos", "vendor_tos"], "constraints": ["notNull"], "required": true },
        "version": { "type": "varchar(20)", "constraints": ["notNull"], "required": true, "notes": "e.g., 1.0, 1.1" },
        "url": { "type": "varchar(255)", "constraints": ["notNull"], "required": true, "notes": "Link to policy page" },
        "lastValidated": { "type": "timestamp", "constraints": ["notNull"], "required": true, "notes": "Last validated YYYY-MM-DD" },
        "createdAt": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true },
        "updatedAt": { "type": "timestamp", "constraints": ["defaultNow", "onUpdateNow", "notNull"], "required": true }
      }
    },
    "consents": {
      "columns": 7,
      "primaryKey": "id",
      "foreignKeys": ["userId → users.id (onDelete: cascade)", "agreementId → agreements.id"],
      "description": "User Consents (Append-Only Ledger) - immutable audit trail of all user consent actions",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "userId": { "type": "int", "constraints": ["notNull", "references:users.id"], "required": true },
        "agreementId": { "type": "int", "constraints": ["notNull", "references:agreements.id"], "required": true },
        "version": { "type": "varchar(20)", "constraints": ["notNull"], "required": true },
        "ip": { "type": "varchar(45)", "constraints": [], "required": false, "notes": "IPv4 or IPv6" },
        "ua": { "type": "text", "constraints": [], "required": false, "notes": "User Agent" },
        "createdAt": { "type": "timestamp", "constraints": ["defaultNow", "notNull"], "required": true }
      }
    },
    "melbourne_postcodes": {
      "columns": 5,
      "primaryKey": "id",
      "description": "Melbourne Postcodes & Suburbs Reference - used for hyper-local geofencing and validation",
      "columns_detail": {
        "id": { "type": "int", "constraints": ["autoincrement", "primaryKey"], "required": true },
        "postcode": { "type": "varchar(4)", "constraints": ["notNull", "unique"], "required": true },
        "suburb": { "type": "varchar(100)", "constraints": ["notNull"], "required": true },
        "region": { "type": "varchar(100)", "constraints": [], "required": false, "notes": "e.g., Inner Melbourne, Eastern Suburbs" },
        "latitude": { "type": "varchar(20)", "constraints": [], "required": false },
        "longitude": { "type": "varchar(20)", "constraints": [], "required": false }
      }
    }
  },
  "summary": {
    "totalTables": 6,
    "totalColumns": 52,
    "tables": [
      "users",
      "businesses",
      "vendors_meta",
      "agreements",
      "consents",
      "melbourne_postcodes"
    ],
    "keyFeatures": [
      "Manus OAuth authentication with role-based access",
      "Business directory with ABN verification",
      "Vendor Stripe payment integration (vendors_meta)",
      "Legal agreement tracking (buyer_tos, vendor_tos)",
      "Immutable consent audit trail",
      "Melbourne postcode geofencing reference"
    ],
    "differences_from_copilot": {
      "new_tables": ["vendors_meta"],
      "renamed_tables": ["melbourne_suburbs → melbourne_postcodes"],
      "table_differences": [
        "consents: MVP links to agreements table (enforces legal agreement tracking)"
      ]
    }
  }
}
