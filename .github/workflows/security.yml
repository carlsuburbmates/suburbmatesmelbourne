name: Security & Dependency Management

on:
  schedule:
    # Check for security updates daily at 1 AM UTC
    - cron: "0 1 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  security-events: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: |
          echo "ğŸ” Running comprehensive security audit..."
          pnpm audit --json > audit-results.json || true

      - name: Parse audit results
        run: |
          if [ -s audit-results.json ]; then
            echo "ğŸ“Š Security audit found issues:"
            cat audit-results.json | jq '.vulnerabilities | to_entries[] | {package: .key, severity: .value.severity}'
          else
            echo "âœ… No security vulnerabilities found"
          fi

      - name: Check for outdated packages
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          pnpm outdated || true

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.4.1

      - name: Update patch and minor versions
        run: |
          echo "ğŸ”„ Updating patch and minor versions..."
          pnpm update --latest

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update dependencies to latest secure versions"
          title: "ğŸ”’ Security & Dependency Updates"
          body: |
            ## ğŸ”’ Automated Security & Dependency Updates

            This PR contains automated updates for:
            - Security vulnerability fixes
            - Patch and minor version updates
            - Dependencies with known security issues

            ### ğŸ›¡ï¸ Security Benefits
            - Addresses known vulnerabilities
            - Updates to latest secure versions
            - Maintains compatibility with existing code

            ### ğŸ” Review Checklist
            - [ ] Check CI/CD pipeline passes
            - [ ] Verify no breaking changes introduced
            - [ ] Review updated package changelogs
            - [ ] Test critical functionality manually

            **Auto-generated by Security Workflow**
          branch: security/dependency-updates
          delete-branch: true
