name: Schema Drift Detector (V1.1 Docs)

on:
  pull_request:

jobs:
  schema-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Validate schema reference fields
        run: |
          if [ ! -f "v1.1/docs/DEV_NOTES/automation/schema_guard.json" ]; then
            echo "❌ schema_guard.json not found."
            exit 1
          fi

          SCHEMA_FILE=$(jq -r '.schema_file' v1.1/docs/DEV_NOTES/automation/schema_guard.json)
          if [ ! -f "$SCHEMA_FILE" ]; then
            echo "❌ Schema reference file not found: $SCHEMA_FILE"
            exit 1
          fi

          jq -r '.required_fields[]' v1.1/docs/DEV_NOTES/automation/schema_guard.json |
          while read -r field; do
            [ -z "$field" ] && continue
            if ! grep -q "$field" "$SCHEMA_FILE"; then
              echo "❌ Missing required schema field in $SCHEMA_FILE: $field"
              exit 1
            fi
          done

          echo "✅ Schema guard passed for $SCHEMA_FILE."
